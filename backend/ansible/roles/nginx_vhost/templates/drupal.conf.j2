server {
	listen [::]:80;
	listen      80;
	access_log      /home/{{ dropfactory_site_platform_user }}/log/access.log;
	error_log       /home/{{ dropfactory_site_platform_user }}/log/error.log;
	server_name {{ dropfactory_site_domain | join(' ') }};
	
	root /home/{{ dropfactory_site_platform_user }}/platform/web;
	index index.htm index.html index.php;

	location = /favicon.ico {
		log_not_found off;
		access_log off;
	}
	
	location = /robots.txt {
		allow all;
		log_not_found off;
		access_log off;
	}
	
	# Very rarely should these ever be accessed outside of your lan
	location ~* \.(txt|log)$ {
		deny all;
	}
	
	location ~ \..*/.*\.php$ {
		return 403;
	}
	
	location ~ ^/sites/.*/private/ {
		return 403;
	}
	
	# Block access to scripts in site files directory
	location ~ ^/sites/[^/]+/files/.*\.php$ {
		deny all;
	}
	
	# Allow "Well-Known URIs" as per RFC 5785
	location ~* ^/.well-known/ {
		allow all;
	}
	
	# Block access to "hidden" files and directories whose names begin with a
	# period. This includes directories used by version control systems such
	# as Subversion or Git to store control files.
	location ~ (^|/)\. {
		return 403;
	}
	
	location / {
		# try_files $uri @rewrite; # For Drupal <= 6
		try_files $uri /index.php?$query_string; # For Drupal >= 7
	}
	
	location @rewrite {
                rewrite ^ /index.php;
	}
	
	# Don't allow direct access to PHP files in the vendor directory.
	location ~ /vendor/.*\.php$ {
		deny all;
		return 404;
	}
	
	# In Drupal 8, we must also match new paths where the '.php' appears in
	# the middle, such as update.php/selection. The rule we use is strict,
	# and only allows this pattern with the update.php front controller.
	# This allows legacy path aliases in the form of
	# blog/index.php/legacy-path to continue to route to Drupal nodes. If
	# you do not have any paths like that, then you might prefer to use a
	# laxer rule, such as:
	#   location ~ \.php(/|$) {
	# The laxer rule will continue to work if Drupal uses this new URL
	# pattern with front controllers other than update.php in a future
	# release.
	location ~ '\.php$|^/update.php' {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/home/{{ dropfactory_site_platform_user }}/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
	}
	
	# Fighting with Styles? This little gem is amazing.
	location ~ ^/sites/.*/files/styles/ { # For Drupal >= 7
		try_files $uri @rewrite;
	}
	
	# Handle private files through Drupal. Private file's path can come
	# with a language prefix.
	location ~ ^(/[a-z\-]+)?/system/files/ { # For Drupal >= 7
		try_files $uri /index.php?$query_string;
	}
	
	location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
		try_files $uri @rewrite;
		expires max;
		log_not_found off;
	}
	# Enforce clean URLs
	# Removes index.php from urls like www.example.com/index.php/my-page --> www.example.com/my-page
	# Could be done with 301 for permanent or other redirect codes.
	if ($request_uri ~* "^(.*/)index\.php(.*)") {
		return 307 $1$2;
	}
    
	#include snippets/{{ dropfactory_site_vhost }}_override*.conf;
}
